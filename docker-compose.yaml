services:
  squid-ui:
    build:
      context: ../squid-ui
    ports:
      - "3000:80"
    volumes:
      - ../squid-ui/nginx.docker.conf:/etc/nginx/conf.d/default.conf:ro
      - ./fm-key-local.txt:/run/secrets/FM_KEY:ro
      - ./config:/usr/share/nginx/html/config
    command:
      - sh
      - -c
      - |
        set -eu
        mkdir -p /usr/share/nginx/html/config
        FM_KEY="$$(cat /run/secrets/FM_KEY)"
        printf '{"envKey":"%s"}\n' "$$FM_KEY" > /usr/share/nginx/html/config/fm.json
        exec nginx -g 'daemon off;'
    depends_on:
      - kraken-auth
    networks:
      - squidstack-net


  nautilus-inventory:
    build:
      context: ../nautilus-inventory
    ports:
      - "8084:8084"
    networks:
      - squidstack-net

  jellyfish-notifications:
    build:
      context: ../jellyfish-notifications
    ports:
      - "8083:8083"
    networks:
      - squidstack-net

  squid-recommendations:
    build:
      context: ../squid-recommendations
    ports:
      - "8085:8085"
    networks:
      - squidstack-net

  barnacle-reviews:
    build:
      context: ../barnacle-reviews
    ports:
      - "8086:8080" # unique host port
    networks:
      - squidstack-net

  octopus-payments:
    build:
      context: ../octopus-payments
    ports:
      - "8088:8080" # unique host port
    networks:
      - squidstack-net

  urchin-analytics:
    build:
      context: ../urchin-analytics
    ports:
      - "8090:8080" # unique host port
    networks:
      - squidstack-net

  kraken-auth:
    build:
      context: ../kraken-auth
    ports:
      - "8080:8080"
    environment:
      - JWT_SECRET=footest
    networks:
      - squidstack-net

  clam-catalog:
    build:
      context: ../clam-catalog
    ports:
      - "8082:8080" # unique host port
    networks:
      - squidstack-net

  cuttlefish-orders:
    build:
      context: ../cuttlefish-orders
    ports:
      - "8089:8080" # unique host port
    networks:
      - squidstack-net

  manta-delivery:
    build:
      context: ../manta-delivery
    ports:
      - "8087:8080" # unique host port
    networks:
      - squidstack-net

  reef-feed-aggregator:
    build:
      context: ../cb-squidstack-reef/reef-feed-aggregator
    ports:
      - "8091:8080" # unique host port
    environment:
      - JWT_SECRET=footest
      - FM_NAMESPACE=squidstack
      - REEF_EU_URL=http://reef-eu:8080
      - REEF_NA_URL=http://reef-na:8080
      - REEF_SA_URL=http://reef-sa:8080
      - REEF_ASIA_URL=http://reef-asia:8080
    volumes:
      - ./fm-key-local.txt:/app/config/fm.json:ro
    networks:
      - squidstack-net

  reef-eu:
    build:
      context: ../cb-squidstack-reef/reef-eu
    ports:
      - "8092:8080" # unique host port
    environment:
      - FM_NAMESPACE=squidstack
    volumes:
      - ./fm-key-local.txt:/app/config/fm.json:ro
    networks:
      - squidstack-net

  reef-na:
    build:
      context: ../cb-squidstack-reef/reef-na
    ports:
      - "8093:8080" # unique host port
    environment:
      - FM_NAMESPACE=squidstack
    volumes:
      - ./fm-key-local.txt:/app/config/fm.json:ro
    networks:
      - squidstack-net

  reef-sa:
    build:
      context: ../cb-squidstack-reef/reef-sa
    ports:
      - "8094:8080" # unique host port
    environment:
      - FM_NAMESPACE=squidstack
    volumes:
      - ./fm-key-local.txt:/app/config/fm.json:ro
    networks:
      - squidstack-net

  reef-asia:
    build:
      context: ../cb-squidstack-reef/reef-asia
    ports:
      - "8095:8080" # unique host port
    environment:
      - FM_NAMESPACE=squidstack
    volumes:
      - ./fm-key-local.txt:/app/config/fm.json:ro
    networks:
      - squidstack-net

networks:
  squidstack-net:
    driver: bridge