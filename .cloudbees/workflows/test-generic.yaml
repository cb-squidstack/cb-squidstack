apiVersion: automation.cloudbees.io/v1alpha1
kind: workflow
name: Shared Test Template

on:
  workflow_call:
    inputs:
      app_name:
        type: string
        required: true
      language:
        type: string
        required: true        # go | node | python
      coverage_root:
        type: string
        required: false
        default: src
      debug:
        type: string
        required: false
        default: "false"
      enable_smart_tests:
        type: string
        required: false
        default: "false"
        description: "Enable CloudBees Smart Tests integration (requires LAUNCHABLE_TOKEN secret)"
      smart_tests_org:
        type: string
        required: false
        default: "d9a801f1-331e-4e61-8100-435303707e42"
        description: "Smart Tests organization ID for URLs"
      smart_tests_workspace:
        type: string
        required: false
        default: "d9a801f1-331e-4e61-8100-435303707e42"
        description: "Smart Tests workspace ID for URLs"
      smart_tests_target:
        type: string
        required: false
        default: ""
        description: "Smart Tests subset target (e.g., '80%', '10m', '5m'). Empty = use defaults"
      smart_tests_confidence:
        type: string
        required: false
        default: ""
        description: "Smart Tests confidence level (0-100). Empty = use defaults"
      smart_tests_observation:
        type: string
        required: false
        default: ""
        description: "Number of historical sessions to analyze. Empty = use defaults"
      fetch_depth:
        type: number
        required: false
        default: 0
        description: "Number of commits to fetch (0 = all history). Full history recommended for Smart Tests to analyze commits and provide accurate test predictions."

jobs:
  test:
    # Expose a single normalized output to callers
    outputs:
      CODE_COVERAGE: ${{ steps.ChooseCoverage.outputs.CODE_COVERAGE }}
      TEST_SUMMARY: ${{ steps.ChooseCoverage.outputs.TEST_SUMMARY }}
      SMART_TESTS_SUMMARY: ${{ steps.ChooseCoverage.outputs.SMART_TESTS_SUMMARY }}
    steps:
      - name: Checkout source
        uses: cloudbees-io/checkout@v2
        with:
          fetch-depth: ${{ inputs.fetch_depth }}

      # ----------------------- GO -----------------------
      - name: Run Go tests
        if: ${{ inputs.language == 'go' }}
        id: GoTests
        kind: test
        uses: docker://golang:1.24-alpine
        env:
          CI: "true"
          DEBUG: ${{ inputs.debug }}
          # >>> CloudBees Smart Tests integration <<<
          APP_NAME: ${{ inputs.app_name }}
          LAUNCHABLE_TOKEN: ${{ secrets.LAUNCHABLE_TOKEN }}
          CLOUDBEES_BUILD_ID: ${{ cloudbees.run_id }}
        run: |
          set -eu
          apk add --no-cache git curl libxml2-utils
          go install github.com/jstemmer/go-junit-report/v2@latest

          # ========== CloudBees Smart Tests Integration START ==========
          # Install Launchable CLI (optional, only if enabled and token provided)
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
            echo "=== Installing CloudBees Smart Tests CLI ==="
            apk add --no-cache python3 py3-pip openjdk17-jre-headless || {
              echo "Warning: Dependencies installation failed, continuing without Smart Tests"
              unset LAUNCHABLE_TOKEN
            }
            if [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
              pip3 install launchable --break-system-packages || {
                echo "Warning: Launchable CLI install failed, continuing without Smart Tests"
                unset LAUNCHABLE_TOKEN
              }
            fi
          fi

          # Record build to Smart Tests
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
            echo "=== Recording build to Smart Tests ==="
            launchable record build --name "cb-squidstack-${APP_NAME}-${CLOUDBEES_BUILD_ID}" > /tmp/launchable-build.txt || {
              echo "Warning: Build recording failed, continuing without Smart Tests"
              unset LAUNCHABLE_TOKEN
            }
            if [ -f /tmp/launchable-build.txt ]; then
              cat /tmp/launchable-build.txt
            fi
          fi

          # Create test session
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
            echo "=== Creating Smart Tests session ==="
            launchable record session --build "cb-squidstack-${APP_NAME}-${CLOUDBEES_BUILD_ID}" --test-suite "${APP_NAME}-tests" > /tmp/launchable-session.txt || {
              echo "Warning: Session creation failed, running all tests"
              unset LAUNCHABLE_TOKEN
            }
          fi

          # Get test subset
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
            echo "=== Getting Smart Tests subset ==="
            # Build subset command with optional parameters
            SUBSET_ARGS="--session $(cat /tmp/launchable-session.txt)"
            if [ -n "${{ inputs.smart_tests_target }}" ]; then
              SUBSET_ARGS="$SUBSET_ARGS --target ${{ inputs.smart_tests_target }}"
              echo "Using target: ${{ inputs.smart_tests_target }}"
            fi
            if [ -n "${{ inputs.smart_tests_confidence }}" ]; then
              SUBSET_ARGS="$SUBSET_ARGS --confidence ${{ inputs.smart_tests_confidence }}"
              echo "Using confidence: ${{ inputs.smart_tests_confidence }}"
            fi
            if [ -n "${{ inputs.smart_tests_observation }}" ]; then
              SUBSET_ARGS="$SUBSET_ARGS --observation ${{ inputs.smart_tests_observation }}"
              echo "Using observation: ${{ inputs.smart_tests_observation }}"
            fi
            # Generate list of all Go test files and pipe to subset command
            find . -type f -name "*_test.go" | \
              launchable subset $SUBSET_ARGS file > /tmp/launchable-subset.txt || {
              echo "Warning: Subset generation failed, running all tests"
              rm -f /tmp/launchable-subset.txt
            }

            if [ -s /tmp/launchable-subset.txt ]; then
              echo "=== Smart Tests subset generated ==="
              cat /tmp/launchable-subset.txt
            fi
          fi
          # ========== CloudBees Smart Tests Integration END ==========

          set +e
          set -o pipefail

          # Run tests (subset or all)
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ] && [ -s /tmp/launchable-subset.txt ]; then
            echo "=== Running Smart Tests subset ==="
            # Convert file list to Go package paths for testing
            # For each test file, get its directory and prefix with ./ (but handle root . specially)
            SUBSET_PACKAGES=$(cat /tmp/launchable-subset.txt | while read f; do
              dir=$(dirname "$f")
              if [ "$dir" = "." ]; then
                echo "."
              else
                echo "./$dir"
              fi
            done | sort -u | paste -sd ' ' -)
            go test ${SUBSET_PACKAGES} -v -coverprofile=coverage.out 2>&1 | tee test_stdout.txt
          else
            echo "=== Running all tests (Smart Tests not active) ==="
            go test ./... -v -coverprofile=coverage.out 2>&1 | tee test_stdout.txt
          fi
          STATUS=$?
          set +o pipefail
          set -e

          # Convert JSON output to JUnit XML
          "$(go env GOPATH)"/bin/go-junit-report -set-exit-code < test_stdout.txt > junit.xml || true

          # Add file attributes to JUnit XML for Smart Tests file profile (using awk instead of Python)
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ] && [ -f junit.xml ] && [ -s /tmp/launchable-subset.txt ]; then
            echo "=== Adding file attributes to JUnit XML ==="
            # Build package->file mapping
            while read test_file; do
              pkg_dir=$(dirname "$test_file" | sed 's|^\./||')
              if [ "$pkg_dir" = "." ]; then
                pkg_name="${APP_NAME}"
              else
                pkg_name="${APP_NAME}/$pkg_dir"
              fi
              # Use xmllint to add file attribute to matching testsuite (only once per package)
              if ! grep -q "<testsuite.*name=\"$pkg_name\".*file=" junit.xml; then
                sed -i.bak "s|<testsuite name=\"$pkg_name\"|<testsuite name=\"$pkg_name\" file=\"$test_file\"|" junit.xml
              fi
            done < /tmp/launchable-subset.txt
            rm -f junit.xml.bak
          fi

          # Record test results to Smart Tests
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ] && [ -f junit.xml ]; then
            echo "=== Recording test results to Smart Tests ==="
            launchable record tests --session "$(cat /tmp/launchable-session.txt)" --test-suite "${APP_NAME}-tests" file junit.xml || {
              echo "Warning: Test result recording failed"
            }
          fi

          # Generate Smart Tests summary for evidence
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
            BUILD_NAME="cb-squidstack-${APP_NAME}-${CLOUDBEES_BUILD_ID}"
            SESSION_PATH=$(cat /tmp/launchable-session.txt 2>/dev/null || echo "unknown")
            # Extract just the session number from the path (e.g., "builds/.../test_sessions/5561168" -> "5561168")
            SESSION_ID=$(echo "$SESSION_PATH" | sed 's|.*/test_sessions/||')

            # Extract build ID from build recording output (if available)
            if [ -f /tmp/launchable-build.txt ]; then
              BUILD_ID=$(grep -oE 'builds/[0-9]+' /tmp/launchable-build.txt | sed 's|builds/||' || echo "")
            else
              BUILD_ID=""
            fi

            # Construct URLs using cbp.launchableinc.com format
            ORG_ID="${{ inputs.smart_tests_org }}"
            WS_ID="${{ inputs.smart_tests_workspace }}"
            BASE_URL="https://cbp.launchableinc.com/organizations/${ORG_ID}/workspaces/${WS_ID}/data"

            if [ -n "$BUILD_ID" ]; then
              BUILD_URL="${BASE_URL}/builds/${BUILD_ID}"
              BUILD_LINK="[\`${BUILD_ID}\`](${BUILD_URL})"
            else
              BUILD_LINK="\`${BUILD_NAME}\`"
            fi
            SESSION_URL="${BASE_URL}/test-sessions/${SESSION_ID}"

            # Count subset statistics if subset was generated
            if [ -s /tmp/launchable-subset.txt ]; then
              TOTAL_TESTS=$(find . -type f -name "*_test.go" | wc -l | tr -d ' ')
              SUBSET_TESTS=$(cat /tmp/launchable-subset.txt | wc -l | tr -d ' ')
              REMAINDER_TESTS=$((TOTAL_TESTS - SUBSET_TESTS))
              if [ "$TOTAL_TESTS" -gt 0 ]; then
                SUBSET_PCT=$((SUBSET_TESTS * 100 / TOTAL_TESTS))
              else
                SUBSET_PCT=0
              fi

              {
                echo "### CloudBees Smart Tests"
                echo ""
                echo "**Status:** Enabled ✓"
                echo ""
                echo "**Test Suite:** \`${APP_NAME}-tests\`"
                echo ""
                echo "**Build:** ${BUILD_LINK}"
                echo ""
                echo "**Session:** [${SESSION_ID}](${SESSION_URL})"
                echo ""
                echo "**Subset Statistics:**"
                echo "- Tests selected: ${SUBSET_TESTS} / ${TOTAL_TESTS} (${SUBSET_PCT}%)"
                echo "- Tests deferred: ${REMAINDER_TESTS}"
              } > "$CLOUDBEES_OUTPUTS/SMART_TESTS_SUMMARY"
            else
              {
                echo "### CloudBees Smart Tests"
                echo ""
                echo "**Status:** Enabled (running all tests)"
                echo ""
                echo "**Test Suite:** \`${APP_NAME}-tests\`"
                echo ""
                echo "**Build:** ${BUILD_LINK}"
                echo ""
                echo "**Session:** [${SESSION_ID}](${SESSION_URL})"
              } > "$CLOUDBEES_OUTPUTS/SMART_TESTS_SUMMARY"
            fi
          else
            echo "**Status:** Disabled" > "$CLOUDBEES_OUTPUTS/SMART_TESTS_SUMMARY"
          fi

          # Parse test results from JUnit XML
          if [ -f junit.xml ]; then
            TOTAL=$(xmllint --xpath "count(//testcase)" junit.xml 2>/dev/null || echo "0")
            FAILED=$(xmllint --xpath "count(//testcase/failure)" junit.xml 2>/dev/null || echo "0")
            ERRORS=$(xmllint --xpath "count(//testcase/error)" junit.xml 2>/dev/null || echo "0")
            SKIPPED=$(xmllint --xpath "count(//testcase/skipped)" junit.xml 2>/dev/null || echo "0")
            PASSED=$((TOTAL - FAILED - ERRORS - SKIPPED))

            {
              echo "**Tests Run:** $TOTAL"
              echo "**Passed:** $PASSED"
              echo "**Failed:** $FAILED"
              echo "**Errors:** $ERRORS"
              echo "**Skipped:** $SKIPPED"
            } > "$CLOUDBEES_OUTPUTS/TEST_SUMMARY"
          else
            echo "No test results available" > "$CLOUDBEES_OUTPUTS/TEST_SUMMARY"
          fi

          if [ -f coverage.out ]; then
            go tool cover -func=coverage.out > coverage_summary.txt
            { echo '```'; cat coverage_summary.txt; echo '```'; } > "$CLOUDBEES_OUTPUTS/CODE_COVERAGE"
          else
            { echo '```'; echo '(no coverage output captured)'; echo '```'; } > "$CLOUDBEES_OUTPUTS/CODE_COVERAGE"
          fi

          exit $STATUS

      - name: Publish Go test results
        if: ${{ inputs.language == 'go' }}
        kind: test
        uses: cloudbees-io/publish-test-results@v1
        with:
          test-type: JUnit
          folder-name: ${{ cloudbees.workspace }}

      - name: Publish Go evidence
        if: ${{ inputs.language == 'go' }}
        kind: test
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          format: MARKDOWN
          content: |
            ## Test Stage (Go)

            ### Test Results
            ${{ steps.GoTests.outputs.TEST_SUMMARY }}

            ### Code Coverage
            ${{ steps.GoTests.outputs.CODE_COVERAGE }}

            ${{ steps.GoTests.outputs.SMART_TESTS_SUMMARY }}

      # ---------------------- NODE ----------------------
      - name: Run Node tests
        if: ${{ inputs.language == 'node' }}
        id: NodeTests
        kind: test
        uses: docker://node:20-alpine
        env:
          CI: "true"
          JEST_JUNIT_OUTPUT: ${{ cloudbees.workspace }}/junit.xml
          JEST_JUNIT_ADD_FILE_ATTRIBUTE: "true"
          COVERAGE_ROOT: ${{ inputs.coverage_root }}
          DEBUG: ${{ inputs.debug }}
          # >>> make tests deterministic <<<
          REACT_APP_LOGIN_LABEL: "Login"
          REACT_APP_SHOW_BETA: "1"
          REACT_APP_SHOW_DEBUG_FOOTER: "1"
          # >>> CloudBees Smart Tests integration <<<
          APP_NAME: ${{ inputs.app_name }}
          LAUNCHABLE_TOKEN: ${{ secrets.LAUNCHABLE_TOKEN }}
          CLOUDBEES_BUILD_ID: ${{ cloudbees.run_id }}
        run: |
          set -eu
          apk add --no-cache git libxml2-utils
          echo "Node: $(node -v)"; echo "NPM: $(npm -v)"
          npm ci
          npm i -D jest-junit

          # ========== CloudBees Smart Tests Integration START ==========
          # Install Launchable CLI (optional, only if enabled and token provided)
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
            echo "=== Installing CloudBees Smart Tests CLI ==="
            apk add --no-cache python3 py3-pip openjdk17-jre-headless || {
              echo "Warning: Dependencies installation failed, continuing without Smart Tests"
              unset LAUNCHABLE_TOKEN
            }
            if [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
              pip3 install launchable --break-system-packages || {
                echo "Warning: Launchable CLI install failed, continuing without Smart Tests"
                unset LAUNCHABLE_TOKEN
              }
            fi
          fi

          # Record build to Smart Tests
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
            echo "=== Recording build to Smart Tests ==="
            launchable record build --name "cb-squidstack-${APP_NAME}-${CLOUDBEES_BUILD_ID}" > /tmp/launchable-build.txt || {
              echo "Warning: Build recording failed, continuing without Smart Tests"
              unset LAUNCHABLE_TOKEN
            }
            if [ -f /tmp/launchable-build.txt ]; then
              cat /tmp/launchable-build.txt
            fi
          fi

          # Create test session
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
            echo "=== Creating Smart Tests session ==="
            launchable record session --build "cb-squidstack-${APP_NAME}-${CLOUDBEES_BUILD_ID}" --test-suite "${APP_NAME}-tests" > /tmp/launchable-session.txt || {
              echo "Warning: Session creation failed, running all tests"
              unset LAUNCHABLE_TOKEN
            }
          fi

          # Get test subset
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
            echo "=== Getting Smart Tests subset ==="
            # Build subset command with optional parameters
            SUBSET_ARGS="--session $(cat /tmp/launchable-session.txt)"
            if [ -n "${{ inputs.smart_tests_target }}" ]; then
              SUBSET_ARGS="$SUBSET_ARGS --target ${{ inputs.smart_tests_target }}"
              echo "Using target: ${{ inputs.smart_tests_target }}"
            fi
            if [ -n "${{ inputs.smart_tests_confidence }}" ]; then
              SUBSET_ARGS="$SUBSET_ARGS --confidence ${{ inputs.smart_tests_confidence }}"
              echo "Using confidence: ${{ inputs.smart_tests_confidence }}"
            fi
            if [ -n "${{ inputs.smart_tests_observation }}" ]; then
              SUBSET_ARGS="$SUBSET_ARGS --observation ${{ inputs.smart_tests_observation }}"
              echo "Using observation: ${{ inputs.smart_tests_observation }}"
            fi
            # Generate list of all test files and pipe to subset command
            find src -type f \( -name "*.test.js" -o -name "*.test.jsx" -o -name "*.test.ts" -o -name "*.test.tsx" \) | \
              launchable subset $SUBSET_ARGS file > /tmp/launchable-subset.txt || {
              echo "Warning: Subset generation failed, running all tests"
              rm -f /tmp/launchable-subset.txt
            }

            if [ -s /tmp/launchable-subset.txt ]; then
              echo "=== Smart Tests subset generated ==="
              cat /tmp/launchable-subset.txt
            fi
          fi
          # ========== CloudBees Smart Tests Integration END ==========

          set +e
          set -o pipefail

          # Run tests (subset or all)
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ] && [ -s /tmp/launchable-subset.txt ]; then
            echo "=== Running Smart Tests subset ==="
            # Convert subset file to Jest testPathPattern
            SUBSET_PATTERN=$(cat /tmp/launchable-subset.txt | sed 's|^./||' | paste -sd '|' -)
            npx react-scripts test --watchAll=false \
              --reporters=default --reporters=jest-junit \
              --coverage \
              --coverageReporters=text --coverageReporters=json-summary \
              --collectCoverageFrom="${COVERAGE_ROOT}/**/*.{js,jsx,ts,tsx}" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/**/*.test.{js,jsx,ts,tsx}" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/**/__tests__/**" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/**/__mocks__/**" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/**/mocks/**" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/**/*.{story,stories}.{js,jsx,ts,tsx}" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/setupTests.{js,ts,tsx}" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/index.{js,jsx,ts,tsx}" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/main.{js,jsx,ts,tsx}" \
              --collectCoverageFrom="!**/*.d.ts" \
              --testPathPattern="${SUBSET_PATTERN}" \
            | tee coverage_stdout.txt
          else
            echo "=== Running all tests (Smart Tests not active) ==="
            npx react-scripts test --watchAll=false \
              --reporters=default --reporters=jest-junit \
              --coverage \
              --coverageReporters=text --coverageReporters=json-summary \
              --collectCoverageFrom="${COVERAGE_ROOT}/**/*.{js,jsx,ts,tsx}" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/**/*.test.{js,jsx,ts,tsx}" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/**/__tests__/**" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/**/__mocks__/**" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/**/mocks/**" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/**/*.{story,stories}.{js,jsx,ts,tsx}" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/setupTests.{js,ts,tsx}" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/index.{js,jsx,ts,tsx}" \
              --collectCoverageFrom="!${COVERAGE_ROOT}/main.{js,jsx,ts,tsx}" \
              --collectCoverageFrom="!**/*.d.ts" \
            | tee coverage_stdout.txt
          fi
          STATUS=$?
          set +o pipefail
          set -e

          # Record test results to Smart Tests
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ] && [ -f junit.xml ]; then
            echo "=== Recording test results to Smart Tests ==="
            launchable record tests --session "$(cat /tmp/launchable-session.txt)" --test-suite "${APP_NAME}-tests" file junit.xml || {
              echo "Warning: Test result recording failed"
            }
          fi

          # Generate Smart Tests summary for evidence
          if [ "${{ inputs.enable_smart_tests }}" = "true" ] && [ -n "${LAUNCHABLE_TOKEN:-}" ]; then
            BUILD_NAME="cb-squidstack-${APP_NAME}-${CLOUDBEES_BUILD_ID}"
            SESSION_PATH=$(cat /tmp/launchable-session.txt 2>/dev/null || echo "unknown")
            # Extract just the session number from the path (e.g., "builds/.../test_sessions/5561168" -> "5561168")
            SESSION_ID=$(echo "$SESSION_PATH" | sed 's|.*/test_sessions/||')

            # Extract build ID from build recording output (if available)
            if [ -f /tmp/launchable-build.txt ]; then
              BUILD_ID=$(grep -oE 'builds/[0-9]+' /tmp/launchable-build.txt | sed 's|builds/||' || echo "")
            else
              BUILD_ID=""
            fi

            # Construct URLs using cbp.launchableinc.com format
            ORG_ID="${{ inputs.smart_tests_org }}"
            WS_ID="${{ inputs.smart_tests_workspace }}"
            BASE_URL="https://cbp.launchableinc.com/organizations/${ORG_ID}/workspaces/${WS_ID}/data"

            if [ -n "$BUILD_ID" ]; then
              BUILD_URL="${BASE_URL}/builds/${BUILD_ID}"
              BUILD_LINK="[\`${BUILD_ID}\`](${BUILD_URL})"
            else
              BUILD_LINK="\`${BUILD_NAME}\`"
            fi
            SESSION_URL="${BASE_URL}/test-sessions/${SESSION_ID}"

            # Count subset statistics if subset was generated
            if [ -s /tmp/launchable-subset.txt ]; then
              TOTAL_TESTS=$(find src -type f \( -name "*.test.js" -o -name "*.test.jsx" -o -name "*.test.ts" -o -name "*.test.tsx" \) | wc -l | tr -d ' ')
              SUBSET_TESTS=$(cat /tmp/launchable-subset.txt | wc -l | tr -d ' ')
              REMAINDER_TESTS=$((TOTAL_TESTS - SUBSET_TESTS))
              if [ "$TOTAL_TESTS" -gt 0 ]; then
                SUBSET_PCT=$((SUBSET_TESTS * 100 / TOTAL_TESTS))
              else
                SUBSET_PCT=0
              fi

              {
                echo "### CloudBees Smart Tests"
                echo ""
                echo "**Status:** Enabled ✓"
                echo ""
                echo "**Test Suite:** \`${APP_NAME}-tests\`"
                echo ""
                echo "**Build:** ${BUILD_LINK}"
                echo ""
                echo "**Session:** [${SESSION_ID}](${SESSION_URL})"
                echo ""
                echo "**Subset Statistics:**"
                echo "- Tests selected: ${SUBSET_TESTS} / ${TOTAL_TESTS} (${SUBSET_PCT}%)"
                echo "- Tests deferred: ${REMAINDER_TESTS}"
              } > "$CLOUDBEES_OUTPUTS/SMART_TESTS_SUMMARY"
            else
              {
                echo "### CloudBees Smart Tests"
                echo ""
                echo "**Status:** Enabled (running all tests)"
                echo ""
                echo "**Test Suite:** \`${APP_NAME}-tests\`"
                echo ""
                echo "**Build:** ${BUILD_LINK}"
                echo ""
                echo "**Session:** [${SESSION_ID}](${SESSION_URL})"
              } > "$CLOUDBEES_OUTPUTS/SMART_TESTS_SUMMARY"
            fi
          else
            echo "**Status:** Disabled" > "$CLOUDBEES_OUTPUTS/SMART_TESTS_SUMMARY"
          fi

          # Parse test results from JUnit XML
          if [ -f junit.xml ]; then
            TOTAL=$(xmllint --xpath "count(//testcase)" junit.xml 2>/dev/null || echo "0")
            FAILED=$(xmllint --xpath "count(//testcase/failure)" junit.xml 2>/dev/null || echo "0")
            ERRORS=$(xmllint --xpath "count(//testcase/error)" junit.xml 2>/dev/null || echo "0")
            SKIPPED=$(xmllint --xpath "count(//testcase/skipped)" junit.xml 2>/dev/null || echo "0")
            PASSED=$((TOTAL - FAILED - ERRORS - SKIPPED))

            {
              echo "**Tests Run:** $TOTAL"
              echo "**Passed:** $PASSED"
              echo "**Failed:** $FAILED"
              echo "**Errors:** $ERRORS"
              echo "**Skipped:** $SKIPPED"
            } > "$CLOUDBEES_OUTPUTS/TEST_SUMMARY"
          else
            echo "No test results available" > "$CLOUDBEES_OUTPUTS/TEST_SUMMARY"
          fi

          if [ -s coverage_stdout.txt ]; then
            { echo '```'; cat coverage_stdout.txt; echo '```'; } > "$CLOUDBEES_OUTPUTS/CODE_COVERAGE"
          else
            { echo '```'; echo '(no coverage output captured)'; echo '```'; } > "$CLOUDBEES_OUTPUTS/CODE_COVERAGE"
          fi

          exit $STATUS

      - name: Publish Node test results
        if: ${{ inputs.language == 'node' }}
        kind: test
        uses: cloudbees-io/publish-test-results@v1
        with:
          test-type: JUnit
          folder-name: ${{ cloudbees.workspace }}/junit.xml

      - name: Publish Node evidence
        if: ${{ inputs.language == 'node' }}
        kind: test
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          format: MARKDOWN
          content: |
            ## Test Stage (Node)

            ### Test Results
            ${{ steps.NodeTests.outputs.TEST_SUMMARY }}

            ### Code Coverage
            ${{ steps.NodeTests.outputs.CODE_COVERAGE }}

            ${{ steps.NodeTests.outputs.SMART_TESTS_SUMMARY }}

      # --------------------- PYTHON ---------------------
      - name: Run Python tests
        if: ${{ inputs.language == 'python' }}
        id: PyTests
        kind: test
        uses: docker://python:3.11-alpine
        env:
          CI: "true"
          DEBUG: ${{ inputs.debug }}
        run: |
          set -eu
          apk add --no-cache gcc musl-dev
          pip install -U pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-cov junit-xml

          set +e
          set -o pipefail
          pytest --junitxml=junit.xml --cov=. --cov-report=term-missing \
          | tee coverage_stdout.txt
          STATUS=$?
          set +o pipefail
          set -e

          if [ -s coverage_stdout.txt ]; then
            { echo '```'; cat coverage_stdout.txt; echo '```'; } > "$CLOUDBEES_OUTPUTS/CODE_COVERAGE"
          else
            { echo '```'; echo '(no coverage output captured)'; echo '```'; } > "$CLOUDBEES_OUTPUTS/CODE_COVERAGE"
          fi

          exit $STATUS

      - name: Publish Python test results
        if: ${{ inputs.language == 'python' }}
        kind: test
        uses: cloudbees-io/publish-test-results@v1
        with:
          test-type: JUnit
          folder-name: ${{ cloudbees.workspace }}

      - name: Publish Python evidence
        if: ${{ inputs.language == 'python' }}
        kind: test
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          format: MARKDOWN
          content: |
            ## Test Stage (Python)
            Code coverage (if available):
            ${{ steps.PyTests.outputs.CODE_COVERAGE }}

      # ---------- Normalize job output for callers ----------
      - name: Choose coverage output
        id: ChooseCoverage
        uses: docker://alpine:3.20
        env:
          GO_COV: ${{ steps.GoTests.outputs.CODE_COVERAGE }}
          GO_TEST: ${{ steps.GoTests.outputs.TEST_SUMMARY }}
          GO_SMART: ${{ steps.GoTests.outputs.SMART_TESTS_SUMMARY }}
          NODE_COV: ${{ steps.NodeTests.outputs.CODE_COVERAGE }}
          NODE_TEST: ${{ steps.NodeTests.outputs.TEST_SUMMARY }}
          NODE_SMART: ${{ steps.NodeTests.outputs.SMART_TESTS_SUMMARY }}
          PY_COV: ${{ steps.PyTests.outputs.CODE_COVERAGE }}
        run: |
          set -eu
          if [ -n "${GO_COV:-}" ]; then
            printf '%s\n' "$GO_COV" > "$CLOUDBEES_OUTPUTS/CODE_COVERAGE"
          elif [ -n "${NODE_COV:-}" ]; then
            printf '%s\n' "$NODE_COV" > "$CLOUDBEES_OUTPUTS/CODE_COVERAGE"
          elif [ -n "${PY_COV:-}" ]; then
            printf '%s\n' "$PY_COV" > "$CLOUDBEES_OUTPUTS/CODE_COVERAGE"
          else
            { echo '```'; echo '(no coverage output captured)'; echo '```'; } > "$CLOUDBEES_OUTPUTS/CODE_COVERAGE"
          fi

          if [ -n "${GO_TEST:-}" ]; then
            printf '%s\n' "$GO_TEST" > "$CLOUDBEES_OUTPUTS/TEST_SUMMARY"
          elif [ -n "${NODE_TEST:-}" ]; then
            printf '%s\n' "$NODE_TEST" > "$CLOUDBEES_OUTPUTS/TEST_SUMMARY"
          else
            echo "No test summary available" > "$CLOUDBEES_OUTPUTS/TEST_SUMMARY"
          fi

          if [ -n "${GO_SMART:-}" ]; then
            printf '%s\n' "$GO_SMART" > "$CLOUDBEES_OUTPUTS/SMART_TESTS_SUMMARY"
          elif [ -n "${NODE_SMART:-}" ]; then
            printf '%s\n' "$NODE_SMART" > "$CLOUDBEES_OUTPUTS/SMART_TESTS_SUMMARY"
          else
            echo "**Status:** Not applicable" > "$CLOUDBEES_OUTPUTS/SMART_TESTS_SUMMARY"
          fi
